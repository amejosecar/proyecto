<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Consulta de datos de las estaciones aemet</title>
    <style>
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f4f4f4;
      }
    </style>
  </head>
  <body>
    <h1>Consulta de datos de las estaciones aemet</h1>

    <div>
      <label for="provincia">Provincia:</label>
      <select id="provincia"></select>
    </div>
    <br /><br />
    <div>
      <label for="estaciones">Estaciones:</label>
      <select id="estaciones"></select>
    </div>
    <br /><br />

    <!-- Botones -->
    <button id="readJsonButton">Leer JSON</button>
    <button id="consultarApi">Consultar API</button>
    <br /><br />
    <div id="tableContainer"></div>

    <script>
      // Variable global para almacenar los datos leídos del JSON
      let jsonData = [];

      // Al pulsar el botón "Leer JSON", se carga el JSON y se actualiza el select de provincias
      document
        .getElementById("readJsonButton")
        .addEventListener("click", () => {
          fetch("../bd/data_estaciones.json")
            .then((response) => {
              if (!response.ok) {
                throw new Error("No se pudo acceder al archivo JSON.");
              }
              return response.json();
            })
            .then((data) => {
              console.log("consulta exitosa");
              console.log("JSON leído:", data);
              // Si el JSON es un arreglo, se almacena directamente; si no, se asume que la primera clave contiene el arreglo
              if (Array.isArray(data)) {
                jsonData = data;
              } else {
                const key = Object.keys(data)[0];
                jsonData = data[key];
              }
              // Extraer las provincias únicas a partir del campo "provincia"
              let provinciasUnicas = [
                ...new Set(jsonData.map((item) => item.provincia)),
              ];
              // Ordenarlas alfabéticamente
              provinciasUnicas.sort((a, b) => a.localeCompare(b));

              const selectProvincia = document.getElementById("provincia");
              selectProvincia.innerHTML = ""; // Limpiar las opciones previas

              provinciasUnicas.forEach((provincia) => {
                if (provincia && provincia.trim() !== "") {
                  const option = document.createElement("option");
                  option.value = provincia;
                  option.textContent = provincia;
                  selectProvincia.appendChild(option);
                }
              });

              // Disparar el evento "change" para actualizar el select de estaciones según la primera provincia
              if (selectProvincia.options.length > 0) {
                selectProvincia.dispatchEvent(new Event("change"));
              }
            })
            .catch((error) => {
              console.error("Error al leer JSON:", error.message);
            });
        });

      // Al cambiar la provincia, se filtran los datos y se actualiza el select de estaciones
      document
        .getElementById("provincia")
        .addEventListener("change", (event) => {
          const selectedProvincia = event.target.value;
          // Filtrar el JSON por la provincia seleccionada
          const filteredResults = jsonData.filter(
            (item) => item.provincia === selectedProvincia
          );
          console.log(
            `Resultados filtrados para provincia "${selectedProvincia}":`,
            filteredResults
          );

          // Extraer las estaciones únicas (se asume que el campo "nombre" contiene la estación)
          let estacionesUnicas = [
            ...new Set(filteredResults.map((item) => item.nombre)),
          ];
          // Ordenar alfabéticamente
          estacionesUnicas.sort((a, b) => a.localeCompare(b));

          const selectEstaciones = document.getElementById("estaciones");
          selectEstaciones.innerHTML = ""; // Limpiar opciones previas

          estacionesUnicas.forEach((estacion) => {
            if (estacion && estacion.trim() !== "") {
              const option = document.createElement("option");
              option.value = estacion;
              option.textContent = estacion;
              selectEstaciones.appendChild(option);
            }
          });

          // Disparar el evento "change" para actualizar la tabla si hay estaciones
          if (selectEstaciones.options.length > 0) {
            selectEstaciones.dispatchEvent(new Event("change"));
          } else {
            // Si no hay estaciones, limpiar la tabla.
            document.getElementById("tableContainer").innerHTML = "";
          }
        });

      // Al cambiar la estación, se filtran los datos y se muestra el resultado en consola y en la tabla
      document
        .getElementById("estaciones")
        .addEventListener("change", (event) => {
          const selectedEstacion = event.target.value;
          // Filtrar los registros que tengan el campo "nombre" igual a la estación seleccionada
          const filteredStationRecords = jsonData.filter(
            (item) => item.nombre === selectedEstacion
          );
          console.log(
            `Resultados para la estación "${selectedEstacion}":`,
            filteredStationRecords
          );

          // Construir la tabla en el contenedor con id "tableContainer"
          const container = document.getElementById("tableContainer");
          container.innerHTML = ""; // Limpiar el contenido previo

          if (filteredStationRecords.length === 0) {
            container.textContent =
              "No se encontraron registros para la estación seleccionada.";
            return;
          }

          const table = document.createElement("table");

          // Crear el encabezado de la tabla usando las keys del primer registro
          const thead = document.createElement("thead");
          const headerRow = document.createElement("tr");
          Object.keys(filteredStationRecords[0]).forEach((key) => {
            const th = document.createElement("th");
            th.textContent = key;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);

          // Crear las filas de datos
          const tbody = document.createElement("tbody");
          filteredStationRecords.forEach((record) => {
            const row = document.createElement("tr");
            Object.entries(record).forEach(([key, value]) => {
              const td = document.createElement("td");
              td.textContent = value;
              row.appendChild(td);
            });
            tbody.appendChild(row);
          });
          table.appendChild(tbody);

          container.appendChild(table);
        });
    </script>
  </body>
</html>
