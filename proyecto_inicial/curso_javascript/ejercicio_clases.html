<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ejercicio JavaScript</title>
    <script src="../js/clase_pelicula.js" type="module"></script>
    <link rel="stylesheet" href="../css/estilos.css" />
    <style>
      select[multiple] {
        width: 300px;
        height: 150px; /* Ajusta la altura del combo box múltiple */
      }
    </style>
  </head>
  <body>
    <h1>Registrar Película</h1>
    <form id="peliculaForm">
      <!-- Resto de los campos -->
      <label for="id">ID de IMDB:</label>
      <input
        type="text"
        id="id"
        name="id"
        placeholder="Ejemplo: tt1234567"
        required
      />
      <span id="idError" class="error"></span>
      
      <label for="titulo">Título:</label>
      <input
        type="text"
        id="titulo"
        name="titulo"
        placeholder="Máx. 100 caracteres"
        required
      />
      <span id="tituloError" class="error"></span>
      
      <label for="director">Director:</label>
      <input
        type="text"
        id="director"
        name="director"
        placeholder="Máx. 50 caracteres"
        required
      />
      <span id="directorError" class="error"></span>
      <br />
      <br />
      <label for="anioEstreno">Año de Estreno:</label>
      <input
        type="number"
        id="anioEstreno"
        name="anioEstreno"
        placeholder="Ejemplo: 2023"
        required
      />
      <span id="anioError" class="error"></span>
      
      
      <label for="calificacion">Calificación IMDB:</label>
      <select id="calificacion" name="calificacion" required>

        <!-- Opciones del 0 al 10 -->
      </select>
      <span id="calificacionError" class="error"></span>
      <br />
      <br />

      <!-- Campo para reflejar los géneros seleccionados -->
      <label for="selectedGeneros">Géneros seleccionados:</label>
      <input type="text" id="selectedGeneros" readonly placeholder="Selecciona géneros" disabled />
      <!-- Campo para reflejar los géneros seleccionados -->
      <label for="selectedPais">Paises seleccionados:</label>
      <input type="text" id="selectedPais" readonly placeholder="Selecciona paiese" disabled />
      <br />
      <br />

      <!-- ComboBox para géneros -->
      <label for="generosComboBox" style="text-align: center;">Género:</label>
      <br />
      <select id="generosComboBox" name="genero" multiple required>
        <!-- Opciones dinámicas aquí -->
      </select>
      <br />
      <br />
      <label for="paisOrigen">País de Origen</label>
      <br />
      <select id="paisComboBox" name="pais" multiple required>
        <!-- Opciones dinámicas aquí -->
      </select>
      <br />
      <br />
  
      <!-- <input
        type="text"
        id="paisOrigen"
        name="paisOrigen"
        placeholder="Ejemplo: EEUU, México"
        required
      />
      <span id="paisError" class="error"></span> -->



      <button type="button" id="submitBtn">Registrar Película</button>
      <button type="reset" id="resetBtn">Limpiar Campos</button>
      <button type="button" id="poblar_tabla">Actualizar tabla</button>
      <br />
      <br />

    </form>
    <h2>Tabla Pelicula</h2>
    <table>
      <thead>
        <th>Título</th>
        <th>Director</th>
        <th>Año</th>
        <th>País</th>
        <th>Género</th>
        <th>Calificación</th>
       </thead>
      <tbody id="tabla_pelis"></tbody>
    </table>

    <h2>Ficha Técnica</h2>
    <div id="fichaTecnica" class="success"></div>
    <br />
    <div id="mensaje_error"></div>

<script type="module">
      // Importar la clase Pelicula
      import { Pelicula } from "../js/clase_pelicula.js";
      import { baseDatos } from "../js/basePeliculas.js";
      let lista_pelis = JSON.parse(localStorage.getItem("peliculas")) || [];

      // Mostrar películas existentes al cargar la página
      function mostrarPeliculas() {
        const tabla = document.getElementById("tabla_pelis");
        tabla.innerHTML = ""; // Limpiar tabla

        lista_pelis.forEach((peli) => {
          const row = document.createElement("tr");
          console.log(peli);

          // Asegúrate de que las propiedades coincidan con tu clase Pelicula
          row.innerHTML = `
                  <td>${peli.titulo}</td>
                  <td>${peli.director}</td>
                  <td>${peli.estreno}</td>
                  <td>${peli.origen.join(", ")}</td>
                  <td>${peli.genero.join(", ")}</td>
                  <td>${peli.calificacion}</td>
                  <td>${peli.reparto.join(", ")}</td>
              `;

          tabla.appendChild(row);
        });
      }

    // Llamar a mostrarPeliculas al cargar la página
    document.getElementById("poblar_tabla").addEventListener("click", mostrarPeliculas);


       // Función para inicializar las opciones del combo box de géneros
      function inicializarGeneros() {
        const generosComboBox = document.getElementById("generosComboBox");
        const generos = Pelicula.generosAceptables();
    
        generos.forEach((genero) => {
          const option = document.createElement("option");
          option.value = genero; // Asignar el valor
          option.textContent = genero; // Asignar el texto visible
          generosComboBox.appendChild(option);
        });
      } 

      // Función para inicializar las opciones del combo box de países
      function inicializarpais() {
        const paisesComboBox = document.getElementById("paisComboBox");
        const paises = Pelicula.paisesAceptables();
        paises.forEach((pais) => {
            const option = document.createElement("option");
            option.value = pais;
            option.textContent = pais;
            paisesComboBox.appendChild(option);
      });
      }

      // Función para actualizar el campo de géneros seleccionados
      function actualizarGenerosSeleccionados() {
          const generosComboBox = document.getElementById("generosComboBox");
          const selectedGeneros = Array.from(generosComboBox.selectedOptions)
              .map(option => option.value)
              .join(", "); // Combina los valores seleccionados con comas

          const selectedGenerosInput = document.getElementById("selectedGeneros");
          selectedGenerosInput.value = selectedGeneros; // Actualiza el valor del campo de texto
      }
      // Función para actualizar el campo de paises seleccionados
      function actualizarPaisesSeleccionados() {
          const paisesComboBox = document.getElementById("paisComboBox");
          const selectedPais = Array.from(paisesComboBox.selectedOptions)
              .map(option => option.value)
              .join(", "); // Combina los valores seleccionados con comas

          const selectedPaisInput = document.getElementById("selectedPais");
          selectedPaisInput.value = selectedPais; // Actualiza el valor del campo de texto
      }
   
      // Poblar dinámicamente el combo box con valores de 0 a 10
      const calificacionComboBox = document.getElementById("calificacion");

      for (let i = 0; i <= 10; i++) {
        const option = document.createElement("option");
        option.value = i; // Valor de la opción
        option.textContent = i; // Texto visible
        calificacionComboBox.appendChild(option); // Añadir la opción al combo box
      }

      // Función para obtener los valores del formulario
      function obtenerValoresFormulario() {
        const id = document.getElementById("id").value;
        const titulo = document.getElementById("titulo").value;
        const director = document.getElementById("director").value;
        const anioEstreno = +document.getElementById("anioEstreno").value;
        const paisOrigen =  Array.from(document.getElementById("paisComboBox").selectedOptions).map(
          (option) => option.value
        );
        const genero = Array.from(document.getElementById("generosComboBox").selectedOptions).map(
          (option) => option.value
        );
        const calificacion = +document.getElementById("calificacion").value;
    
        return { id, titulo, director, anioEstreno, paisOrigen, genero, calificacion };
      }
    
      // Función para limpiar mensajes de error y ficha técnica
      function limpiarMensajes() {
        document.getElementById("mensaje_error").textContent = ""; // Limpiar errores
        document.getElementById("fichaTecnica").innerHTML = ""; // Limpiar ficha técnica
      }
    
      // Función para manejar el evento "Registrar Película"
      function registrarPelicula() {
        limpiarMensajes(); // Limpiar antes de procesar
    
        try {
          const { id, titulo, director, anioEstreno, paisOrigen, genero, calificacion } =
            obtenerValoresFormulario();
    
          // Crear la instancia de la clase Pelicula
          const pelicula = new Pelicula(
            id,
            titulo,
            director,
            anioEstreno,
            paisOrigen,
            genero,
            calificacion
          );
          localStorage.setItem("peliculas", JSON.stringify(lista_pelis));
          // Mostrar la ficha técnica
          document.getElementById("fichaTecnica").innerHTML = pelicula.fichaTecnica();
        } catch (error) {
          // Mostrar mensaje de error en el div "mensaje_error"
          document.getElementById("mensaje_error").innerHTML = `<p class="error">${error.message}</p>`;
        }
      }


      // Asociar el evento change al combo box de géneros
      document.getElementById("generosComboBox").addEventListener("change", actualizarGenerosSeleccionados);
      
      // Asociar el evento change al combo box de paises
      document.getElementById("paisComboBox").addEventListener("change", actualizarPaisesSeleccionados);
     
      // Función para reiniciar el formulario
      function reiniciarFormulario() {
        document.getElementById("peliculaForm").reset(); // Restablecer todos los campos del formulario
        limpiarMensajes(); // Limpiar mensajes de error y la ficha técnica
        inicializarGeneros(); // Re-inicializar los géneros
      }
    // Inicializar la página
    inicializarGeneros(); // Inicializar los géneros
    inicializarpais(); // Inicializar los países

    // Eventos para los botones
    document.getElementById("submitBtn").addEventListener("click", registrarPelicula);
    document.getElementById("resetBtn").addEventListener("click", reiniciarFormulario); // Asociar el evento al botón de reset

</script>
    
  </body>
</html>
<!-- Fin del archivo HTML -->
<!--
  Este archivo HTML contiene un formulario para registrar una película.
  Incluye validaciones y muestra la ficha técnica de la película registrada.
  Se utiliza la clase Pelicula definida en el archivo clase_pelicula.js.