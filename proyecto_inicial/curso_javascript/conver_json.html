<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leer CSV y guardar como JSON</title>
  </head>
  <body>
    <h1>Conversión de CSV a JSON</h1>
    <input type="file" id="fileInput" accept=".csv" />
    <button id="convertButton">Convertir a JSON</button>
    <button id="saveButton" style="display: none">Guardar JSON</button>
    <pre id="output"></pre>

    <script>
      let jsonData = []; // Variable para almacenar el JSON generado

      document.getElementById("convertButton").addEventListener("click", () => {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (!file) {
          alert("Por favor, selecciona un archivo .csv primero.");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (event) {
          // Obtener el contenido del archivo CSV
          const csvData = event.target.result;
          // Convertir el CSV a JSON usando la primera fila como cabecera
          jsonData = csvToJson(csvData);
          document.getElementById("output").textContent = JSON.stringify(
            jsonData,
            null,
            2
          );
          document.getElementById("saveButton").style.display = "inline-block";
        };
        reader.readAsText(file);
      });

      document.getElementById("saveButton").addEventListener("click", () => {
        if (jsonData.length === 0) {
          alert(
            "No hay datos para guardar. Por favor, convierte primero un archivo CSV."
          );
          return;
        }

        const blob = new Blob([JSON.stringify(jsonData, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "data.json"; // Nombre del archivo que se descargará
        a.click();
        URL.revokeObjectURL(url); // Liberar la memoria usada por el objeto URL
      });

      function csvToJson(csv) {
        // Define el delimitador utilizado en el CSV (modifica si es necesario)
        const delimiter = ";";

        // Separa las líneas y elimina las que estén vacías
        const lines = csv.split("\n").filter((line) => line.trim() !== "");

        if (lines.length === 0) {
          return [];
        }

        // La primera línea se utiliza como cabecera para obtener los nombres de los campos
        const headers = lines[0]
          .split(delimiter)
          .map((header) => header.trim());

        // Mapea las siguientes líneas a objetos usando los nombres de campo de la cabecera
        const result = lines.slice(1).map((line) => {
          const values = line.split(delimiter).map((val) => val.trim());
          const obj = {};
          headers.forEach((header, index) => {
            obj[header] = values[index] !== undefined ? values[index] : "";
          });
          return obj;
        });

        return result;
      }
    </script>
  </body>
</html>
