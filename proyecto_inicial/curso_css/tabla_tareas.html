<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listado Tareas Americo</title>
    <link rel="stylesheet" href="css/estilo_tareas.css" />
  </head>
  <body>
    <h1>Listado tareas Americo</h1>
    <div class="container">
      <table>
        <thead>
          <tr>
            <th>Tarea</th>
            <th>Fecha</th>
            <th>Importancia</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <!-- Columna Tarea -->
            <td>
              <input
                type="text"
                name="texto_tarea"
                id="tarea_nueva"
                maxlength="40"
                placeholder="Introduce nueva tarea"
              />
            </td>
            <!-- Columna Fecha -->
            <td>
              <input type="datetime-local" id="momento" />
            </td>
            <!-- Columna Importancia -->
            <td>
              <select name="prioridad" id="selector_prioridades">
                <option value="">Seleccione la importancia</option>
                <option value="muy baja">Tarea poco importante</option>
                <option value="baja">Tarea Normal</option>
                <option value="media">Tarea Importante</option>
                <option value="alta">Tarea Urgente</option>
              </select>
            </td>
            <!-- Columna Acción -->
            <td>
              <button type="button" id="aniadir_tarea">Añadir</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <h3>Tareas</h3>
    <div>
      <table>
        <thead>
          <tr>
            <th scope="col">Fecha</th>
            <th scope="col">Tarea</th>
            <th scope="col">Importancia</th>
            <th scope="col">Borrar</th>
            <th scope="col">Ejecutada</th>
          </tr>
        </thead>
        <tbody id="tabla_tareas"></tbody>
      </table>
    </div>
    <!-- Contenedor para el Toast -->
    <div id="toast" class="toast"></div>

    <script>
      let tareas = [];
      class Tarea {
        constructor(fecha, texto, importancia) {
          console.log(fecha.valueOf());
          if (!fecha.valueOf()) {
            fecha = new Date();
          }
          this.fecha = fecha;
          this.texto = texto;
          this.importancia = importancia;
          this.hecha = false;
        }

        creaFila(indice) {
          let filaTarea = document.createElement("tr");
          filaTarea.innerHTML = `<th scope="row">${this.fecha.toLocaleString()}</th>
            <td>${this.texto}</td>
            <td>${this.importancia}</td>
            <td class="casilla_borrar"></td>
            <td class="casilla_ejecutar"></td>`;
          let botonBorrar = document.createElement("button");
          botonBorrar.classList.add("boton_borrar");
          botonBorrar.innerText = "Borrar";
          botonBorrar.addEventListener("click", () => borrarItem(indice));
          let casillaBorrar =
            filaTarea.getElementsByClassName("casilla_borrar")[0];
          casillaBorrar.appendChild(botonBorrar);

          let botonEjecutar = document.createElement("button");
          botonEjecutar.classList.add("boton_ejecutar");
          botonEjecutar.innerText = "Ejecutada";
          botonEjecutar.disabled = this.hecha;
          botonEjecutar.addEventListener("click", () => ejecutarItem(indice));
          let casillaEjecutar =
            filaTarea.getElementsByClassName("casilla_ejecutar")[0];
          casillaEjecutar.appendChild(botonEjecutar);

          filaTarea.setAttribute("importancia", this.importancia);
          if (this.hecha) {
            filaTarea.classList.add("finalizada");
          }
          return filaTarea;
        }
      }

      // Función para mostrar Toast con el mensaje recibido.
      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("show");
        // El Toast desaparece después de 3 segundos.
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      const borrarItem = function (indice) {
        console.log("borro " + indice);
        if (
          confirm(
            `¿Quieres eliminar la tarea "${tareas[indice].texto}" de la fecha ${tareas[indice].fecha}?`
          )
        ) {
          tareas.splice(indice, 1);
          renderizarListado();
          // Se muestra el Toast al borrar la tarea.
          showToast("Has borrado una tarea");
        }
      };

      const ejecutarItem = function (indice) {
        console.log("Ejecuto la tarea " + tareas[indice].texto);
        if (
          confirm(
            `¿Quieres marcar como ejecutada la tarea "${tareas[indice].texto}" de la fecha ${tareas[indice].fecha}?`
          )
        ) {
          tareas[indice].hecha = !tareas[indice].hecha;
          console.log("Ejecutada la tarea " + tareas[indice].texto);
          renderizarListado();
          // Se muestra el Toast al marcar la tarea como ejecutada.
          showToast("Has marcado la tarea como ejecutada");
        }
      };

      const renderizarListado = function () {
        let tablaTareas = document.getElementById("tabla_tareas");
        tablaTareas.innerHTML = "";
        tareas.forEach((tarea, indice) => {
          let filaTarea = tarea.creaFila(indice);
          //console.log(filaTarea);
          tablaTareas.appendChild(filaTarea);
        });
      };

      const has_aniadido = function (tareaNueva) {
        let notificacion = document.createElement("div");
        notificacion.classList.add("notificacion_aniadido");
        notificacion.innerText = `Has añadido la tarea ${
          tareaNueva.texto
        }, ${tareaNueva.fecha.toLocaleString()}`;
        document.body.appendChild(notificacion);
        setTimeout(() => {
          notificacion.classList.add("fade-out");
          setTimeout(() => {
            document.body.removeChild(notificacion);
          }, 500);
        }, 5000);
      };

      const limpieza = function () {
        let input_tarea = document.getElementById("tarea_nueva");
        let input_momento = document.getElementById("momento");
        let input_importancia = document.getElementById("selector_prioridades");
        input_tarea.value = "";
        input_momento.value = "";
        input_importancia.value = "";
      };
      const aniadirTarea = function () {
        let input_tarea = document.getElementById("tarea_nueva");
        let input_momento = document.getElementById("momento");
        let input_importancia = document.getElementById("selector_prioridades");
        //let tareaNueva = {};
        //tareaNueva.texto = input_tarea.value;
        //tareaNueva.fecha = new Date(input_momento.value);

        if (input_tarea.value.trim() !== "") {
          if (input_importancia.value.trim() !== "") {
            // Ambos campos tienen contenido
            tareaNueva = new Tarea(
              new Date(input_momento.value),
              input_tarea.value,
              input_importancia.value
            );
            console.log(tareaNueva);
            tareas.unshift(tareaNueva);
            has_aniadido(tareaNueva);
            renderizarListado();
            limpieza();
            return true;
          } else {
            alert("El campo 'Importancia' no puede estar vacío.");
            input_importancia.focus();
            return false;
          }
        } else {
          alert("El campo 'Tarea' no puede estar vacío.");
          input_tarea.focus();
          return false;
        }
      };
      document
        .getElementById("aniadir_tarea")
        .addEventListener("click", aniadirTarea);
    </script>
  </body>
</html>
